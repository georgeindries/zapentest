import React, { useCallback, useEffect, useState } from "react";
import { useSelector } from "react-redux";
import { NavLink } from "react-router-dom";
import { EyeOutlined, LoadingOutlined } from "@ant-design/icons";
import classes from "./Scan.module.css";
import axios from "axios";
import { Table, Progress } from "antd";

const Scan = () => {
  const token = useSelector((state) => state.auth.token);
  const [isLoading, setLoading] = useState(false);
  const [scanRequests, setScanRequests] = useState();
  let search = window.location.search;
  let queryParams = new URLSearchParams(search);
  let url = queryParams.get("url");

  const columns = [
    {
      title: "URL",
      dataIndex: "url",
    },
    {
      title: "DATE",
      dataIndex: "date",
    },
    {
      title: "STATUS",
      dataIndex: "status",
      render: (_, { status }) => (
        <div>
          {status.toUpperCase() === "NEW" && (
            <Progress type="circle" percent={0} width={22} title={"NEW"} />
          )}
          {status.toUpperCase() === "IN_PROGRESS" && (
            <LoadingOutlined
              style={{ fontSize: 24 }}
              title={"IN PROGRESS"}
              spin
            />
          )}
          {status.toUpperCase() === "FAILED" && (
            <Progress
              type="circle"
              percent={0}
              width={22}
              status="exception"
              title={"FAILED"}
            />
          )}
          {status.toUpperCase() === "DONE" && (
            <Progress type="circle" percent={100} width={22} title={"DONE"} />
          )}
        </div>
      ),
    },
    {
      title: "VIEW",
      dataIndex: "view",
      render: (link) => {
        return (
          <div>
            <NavLink to={link}>
              <EyeOutlined style={{ marginRight: 5 }} />
              Issues
            </NavLink>
          </div>
        );
      },
    },
  ];

  const [currentPage, setCurrentPage] = useState(1);
  const [totalItems, setTotalItems] = useState(0);
  const limit = 10;

  const fetchScanRequests = useCallback(() => {
    setLoading(true);
    const requestUrl =
      url !== undefined && url !== null
        ? `http://localhost:5000/scan/requests?page=${currentPage}&limit=${limit}&url=${url}`
        : `http://localhost:5000/scan/requests?page=${currentPage}&limit=${limit}`;
    axios
      .get(requestUrl, {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      })
      .then((resObj) => {
        setLoading(false);
        const data = resObj.data.scanRequests;
        const size = resObj.data.size;
        const scanRequests = data.map((scanRequest, index) => {
          const id = scanRequest.id;
          return {
            key: index,
            id: scanRequest.id,
            url: scanRequest.url,
            maxChildren: scanRequest.maxChildren,
            recurse: scanRequest.recurse.toString(),
            subtreeOnly: scanRequest.subtreeOnly.toString(),
            date: new Date(scanRequest.date).toLocaleString(),
            status: scanRequest.status,
            view: `scan/${id}/alerts`,
          };
        });
        setTotalItems(size);
        setScanRequests(scanRequests);
      })
      .catch((errObj) => {
        setLoading(false);
        console.log(errObj);
      });
  }, [token, currentPage, limit, url]);

  useEffect(() => {
    fetchScanRequests();
  }, [fetchScanRequests]);

  const onPageChange = (page, c) => {
    setCurrentPage(page);
  };

  return (
    <div>
      <div className="tableTitle">Active Scan Requests</div>
      <div className={classes.requests}>
        <Table
          className="customTable"
          columns={columns}
          dataSource={scanRequests}
          loading={isLoading}
          pagination={{
            pageSize: limit,
            total: totalItems,
            current: currentPage,
            onChange: onPageChange,
          }}
          expandable={{
            expandedRowRender: (scanRequest) => (
              <div>
                <h4 style={{ fontWeight: 700 }}>
                  MAX CHILDREN:{" "}
                  <span style={{ fontWeight: 100 }}>
                    {scanRequest.maxChildren}
                  </span>
                </h4>
                <h4 style={{ marginTop: 20, fontWeight: 700 }}>
                  RECURSE:{" "}
                  <span style={{ fontWeight: 100 }}>
                    {scanRequest.recurse.toUpperCase()}
                  </span>
                </h4>
                <h4 style={{ marginTop: 20, fontWeight: 700 }}>
                  SUBTREE ONLY:{" "}
                  <span style={{ fontWeight: 100 }}>
                    {scanRequest.subtreeOnly.toUpperCase()}
                  </span>
                </h4>
              </div>
            ),
            rowExpandable: (record) => record.name !== "Not Expandable",
          }}
        />
      </div>
    </div>
  );
};

export default Scan;
